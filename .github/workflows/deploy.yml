name: CI/CD with Minikube for BankingSystem

on:
  pull_request:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy BankingSystem on Minikube

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Minikube
        uses: medyagh/setup-minikube@latest

      - name: Verify cluster
        run: kubectl get nodes

      - name: Build Docker image inside Minikube
        run: |
          minikube image build -t local/banking-system:latest BankingSystem

      - name: Deploy app to Minikube
        run: |
          kubectl apply -f BankingSystem/Deployment.yaml
          kubectl wait --for=condition=ready pod -l app=banking-system --timeout=120s

      - name: Test Service Access
        run: |
          minikube service banking-system-svc --url
          curl $(minikube service banking-system-svc --url) || echo "Service might not have a valid endpoint"

      - name: Deployment successful
        run: echo "âœ… BankingSystem deployed and tested!"
